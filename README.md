### **ECOSSISTEMA DE GERA√á√ÉO DE RELAT√ìRIOS PARA PESSOA F√çSICA**

#### **Descri√ß√£o**
O objetivo deste √©pico √© desenvolver um ecossistema distribu√≠do para gera√ß√£o de relat√≥rios financeiros sobre pessoas f√≠sicas. O sistema dever√° ser capaz de processar solicita√ß√µes de relat√≥rios b√°sicos e completos, garantindo a correta cobran√ßa dos valores, a integridade dos dados e a alta disponibilidade dos servi√ßos.

O sistema ser√° composto por **quatro aplica√ß√µes independentes** que se comunicam entre si via REST e mensageria (RabbitMQ). Al√©m disso, dever√° garantir resili√™ncia em caso de falhas e ser implementado seguindo boas pr√°ticas de microsservi√ßos, incluindo escalabilidade, testes unit√°rios, e controle de transa√ß√µes com rollback.

---

### **Justificativa**
Este √©pico foi definido para atender √†s necessidades do cliente, fornecendo um sistema modular e distribu√≠do para gera√ß√£o de relat√≥rios com alto desempenho, seguran√ßa e resili√™ncia. A arquitetura baseada em microsservi√ßos permite escalabilidade e facilita a manuten√ß√£o a longo prazo.

Dada a necessidade de cobran√ßa pelos relat√≥rios, √© essencial que o sistema mantenha um controle financeiro preciso e implemente rollback adequado em caso de falhas. Al√©m disso, como o relat√≥rio completo depende da execu√ß√£o simult√¢nea de dois servi√ßos, a solu√ß√£o deve garantir a execu√ß√£o ass√≠ncrona e a consolida√ß√£o dos resultados.

---

### **Requisitos Funcionais**

1Ô∏è **Solicita√ß√£o de Relat√≥rio:** O sistema deve permitir que o usu√°rio solicite a gera√ß√£o de um relat√≥rio informando **CPF** e **tipo de relat√≥rio** (**b√°sico** ou **completo**).

2Ô∏è **Relat√≥rio B√°sico:** O relat√≥rio b√°sico deve conter as seguintes informa√ß√µes p√∫blicas:
   - Nome  
   - Sexo  
   - Nacionalidade  

3Ô∏è **Relat√≥rio Completo:** O relat√≥rio completo deve conter todas as informa√ß√µes do relat√≥rio b√°sico, al√©m de:
   - Endere√ßo  
   - Telefone  
   - Documentos (RG e CPF)  

4Ô∏è **Restri√ß√£o de Relat√≥rio por CPF:** O sistema deve validar o CPF e, **caso a soma dos n√∫meros seja igual a 44**, o relat√≥rio **n√£o poder√° ser exibido** e deve retornar uma mensagem informando que o acesso √© negado.

5Ô∏è **Cobran√ßa do Relat√≥rio:** O sistema deve cobrar **R$5,00** pelo relat√≥rio b√°sico e **R$10,00** pelo relat√≥rio completo. 

6Ô∏è **Registro da Cobran√ßa no Banco de Dados:** O valor da cobran√ßa deve ser **salvo no banco de dados antes da gera√ß√£o do relat√≥rio** e **inclu√≠do na resposta da API**.

7 **Gera√ß√£o Ass√≠ncrona do Relat√≥rio Completo:** O relat√≥rio completo deve ser gerado **de forma ass√≠ncrona**, acionando os servi√ßos respons√°veis por **Relat√≥rio B√°sico e Relat√≥rio Completo** para consolidar os dados.

8 **Consolida√ß√£o do Relat√≥rio Completo:** O sistema deve consolidar as informa√ß√µes recebidas dos microsservi√ßos e **retornar um JSON √∫nico** ao usu√°rio.

9 **Mecanismo de Reexecu√ß√£o em Caso de Falha:** Caso um dos microsservi√ßos de relat√≥rio falhe, o sistema deve realizar **duas novas tentativas**, com um intervalo de **300ms** entre elas.

10 **Rollback da Cobran√ßa em Caso de Falha:** Caso a gera√ß√£o do relat√≥rio completo falhe **mesmo ap√≥s as tentativas**, o sistema deve:
   - **Realizar rollback da cobran√ßa** do relat√≥rio completo no servi√ßo financeiro.  
   - **Cobrar apenas o valor do relat√≥rio b√°sico** e retornar os dados dispon√≠veis.

11 **Cobran√ßa Ass√≠ncrona:** O servi√ßo financeiro deve processar as cobran√ßas **de forma ass√≠ncrona**, utilizando **RabbitMQ e Spring Cloud Stream**.

12 **Padr√£o de Comunica√ß√£o REST e JSON:** O sistema deve **expor endpoints REST** e **responder todas as requisi√ß√µes no formato JSON**.

13 **Documenta√ß√£o Opcional via Swagger:** A aplica√ß√£o **pode ser documentada via Swagger** para facilitar a integra√ß√£o com outras aplica√ß√µes e consumidores da API.

---

#### **N√£o Funcionais**
1. As aplica√ß√µes devem ser desenvolvidas em **Java 17+** utilizando **Spring Boot 3.4.2**.
2. Deve ser utilizado **banco de dados relacional** no servi√ßo de entrada para registrar as cobran√ßas.
3. A arquitetura deve seguir o padr√£o de **microsservi√ßos**.
4. Comunica√ß√£o entre servi√ßos via **REST** e **RabbitMQ**.
5. Implementa√ß√£o de **resili√™ncia** e **controle de transa√ß√µes** com rollback.
6. Testes unit√°rios obrigat√≥rios utilizando **JUnit 5 e Mockito**.
7. Implementa√ß√£o opcional de **Docker e Docker Compose** para deploy local.
8. Utiliza√ß√£o opcional de **Swagger** para documenta√ß√£o.
9. Desenho da arquitetura do ecossistema.
---
#### **Fluxo de Comunica√ß√£o entre os Servi√ßos**
1. **Usu√°rio ‚Üí APP1 (Entrada - API Gateway e Orquestrador)**
   - O usu√°rio faz uma requisi√ß√£o REST (`POST /api/v1/reports`) informando CPF e tipo de relat√≥rio (b√°sico ou completo).
   - O APP1 valida o CPF. Se a soma dos d√≠gitos for **44**, retorna um erro e finaliza a requisi√ß√£o.
   - O APP1 registra a cobran√ßa no banco de dados e envia uma mensagem ao **RabbitMQ** para processar a cobran√ßa no APP4 (Financeiro).

2. **APP1 ‚Üí APP2 e APP3 (Servi√ßos de Relat√≥rios)**
   - Se o usu√°rio solicitou um **relat√≥rio b√°sico**, o **APP1** faz uma **requisi√ß√£o REST s√≠ncrona** para o **APP2** (`GET /api/v1/basic-report/{cpf}`).
   - Se o usu√°rio solicitou um **relat√≥rio completo**, o **APP1** faz **requisi√ß√µes REST ass√≠ncronas** para o **APP2 e APP3** (`GET /api/v1/full-report/{cpf}`).
   - Se o **APP3 falhar**, o **APP1** reenvia a requisi√ß√£o **duas vezes com um intervalo de 300ms**.

3. **APP3 (Relat√≥rio Completo) ‚Üí APP1**
   - O **APP3** processa a requisi√ß√£o de forma **ass√≠ncrona**.
   - Ap√≥s obter os dados detalhados (Endere√ßo, Telefone, Documentos), retorna uma resposta **JSON via REST** para o **APP1**.
   - O **APP1** consolida os dados do **APP2 e APP3** e retorna um JSON √∫nico ao usu√°rio.

4. **APP1 (Entrada) ‚Üí APP4 (Financeiro) via RabbitMQ**
   - O **APP1** envia uma mensagem para o **RabbitMQ** com os detalhes da cobran√ßa.
   - O **APP4 (Financeiro)** escuta essa mensagem e processa a cobran√ßa.
   - Se o **APP3 falhar**, o **APP1** publica um **evento de rollback no RabbitMQ**, e o **APP4** ajusta a cobran√ßa para o relat√≥rio b√°sico.
---
### **Hist√≥rias de Usu√°rio**
Hist√≥rias de usu√°rio organizadas por cada um dos quatro aplicativos.

### **Aplica√ß√£o 1: Entrada (API Gateway e Orquestrador)**

#### **1 Solicita√ß√£o do Relat√≥rio**
**Como usu√°rio, quero solicitar a gera√ß√£o de um relat√≥rio informando meu CPF e o tipo de relat√≥rio (b√°sico ou completo), para obter informa√ß√µes sobre uma pessoa f√≠sica.**  
üõ† **Crit√©rios de Aceita√ß√£o:**  
‚úÖ O usu√°rio deve poder escolher entre **relat√≥rio b√°sico** e **relat√≥rio completo**.  
‚úÖ A solicita√ß√£o deve ser feita via **endpoint REST**.  
‚úÖ O sistema deve retornar o JSON com os dados do relat√≥rio gerado.  

#### **2 Valida√ß√£o de CPF com Restri√ß√£o**
**Como sistema, quero validar se o CPF informado possui soma dos d√≠gitos igual a 44, para restringir a exibi√ß√£o do relat√≥rio e informar ao usu√°rio que o acesso √© negado.**  
üõ† **Crit√©rios de Aceita√ß√£o:**  
‚úÖ O sistema deve somar os d√≠gitos do CPF recebido.  
‚úÖ Caso a soma seja **igual a 44**, a requisi√ß√£o deve ser **negada** com uma mensagem informativa.  
‚úÖ O sistema **n√£o deve prosseguir** com a gera√ß√£o do relat√≥rio nem cobrar o usu√°rio nesse caso.  

#### **3 Registro da Cobran√ßa Antes da Gera√ß√£o do Relat√≥rio**
**Como sistema, quero registrar no banco de dados o valor da cobran√ßa antes de iniciar a gera√ß√£o do relat√≥rio, garantindo rastreabilidade do pagamento.**  
üõ† **Crit√©rios de Aceita√ß√£o:**  
‚úÖ O sistema deve gravar no banco **o valor a ser cobrado** assim que a solicita√ß√£o for recebida.  
‚úÖ O valor cobrado deve ser de **R$5,00 para o relat√≥rio b√°sico** e **R$10,00 para o relat√≥rio completo**.  
‚úÖ Se o relat√≥rio n√£o puder ser gerado, a cobran√ßa deve ser **desfeita (rollback financeiro)**.  

#### **4 Retorno do Valor Cobrado na Resposta da API**
**Como sistema, quero incluir o valor cobrado na resposta da API, para que o usu√°rio tenha visibilidade do custo da solicita√ß√£o.**  
üõ† **Crit√©rios de Aceita√ß√£o:**  
‚úÖ A resposta JSON deve conter o campo `"valorCobranca"` informando **R$5,00** ou **R$10,00** conforme o tipo do relat√≥rio solicitado.  
‚úÖ Caso ocorra um rollback financeiro, a resposta deve indicar que a cobran√ßa foi **revertida** e informar o novo valor (R$5,00).  

#### **5 Execu√ß√£o Ass√≠ncrona do Relat√≥rio Completo**
**Como sistema, quero garantir que a requisi√ß√£o de um relat√≥rio completo execute os microsservi√ßos respons√°veis de forma ass√≠ncrona, otimizando o tempo de resposta.**  
üõ† **Crit√©rios de Aceita√ß√£o:**  
‚úÖ O sistema deve **chamar os servi√ßos de Relat√≥rio B√°sico e Relat√≥rio Completo** em paralelo.  
‚úÖ A requisi√ß√£o deve ser **n√£o bloqueante**, permitindo a execu√ß√£o em segundo plano.  
‚úÖ O sistema deve aguardar as respostas antes de consolidar os dados e enviar ao usu√°rio.  

#### **6 Consolida√ß√£o dos Dados dos Relat√≥rios**
**Como sistema, quero consolidar os dados retornados pelos microsservi√ßos de relat√≥rio e devolver um JSON √∫nico ao usu√°rio, garantindo que o relat√≥rio completo contenha todas as informa√ß√µes corretamente organizadas.**  
üõ† **Crit√©rios de Aceita√ß√£o:**  
‚úÖ O JSON final deve conter **os dados do relat√≥rio b√°sico** quando solicitado.  
‚úÖ O JSON final deve conter **os dados do relat√≥rio completo** caso tenha sido gerado com sucesso.  
‚úÖ Caso o relat√≥rio completo falhe, a resposta deve conter **apenas as informa√ß√µes do relat√≥rio b√°sico** e a cobran√ßa ajustada.  

#### **7 Reexecu√ß√£o em Caso de Falha**
**Como sistema, quero realizar at√© duas novas tentativas autom√°ticas, com um intervalo de 300ms entre elas, caso um dos servi√ßos de relat√≥rio falhe, para aumentar a resili√™ncia da aplica√ß√£o.**  
üõ† **Crit√©rios de Aceita√ß√£o:**  
‚úÖ Se um dos servi√ßos falhar, o sistema deve aguardar **300ms** antes de tentar novamente.  
‚úÖ O sistema deve realizar **at√© 2 tentativas adicionais** antes de considerar a requisi√ß√£o como falha.  
‚úÖ Caso todas as tentativas falhem, a requisi√ß√£o deve ser **ajustada para um relat√≥rio b√°sico** com cobran√ßa reduzida.  

#### **8 Rollback da Cobran√ßa e Fallback para Relat√≥rio B√°sico**
**Como sistema, quero garantir rollback da cobran√ßa do relat√≥rio completo caso a gera√ß√£o falhe mesmo ap√≥s as tentativas, e cobrar apenas o relat√≥rio b√°sico, para que o usu√°rio pague apenas pelo servi√ßo efetivamente entregue.**  
üõ† **Crit√©rios de Aceita√ß√£o:**  
‚úÖ Se o relat√≥rio completo n√£o puder ser gerado, o sistema deve **reverter a cobran√ßa** no servi√ßo financeiro.  
‚úÖ O sistema deve **cobrar apenas R$5,00** pelo relat√≥rio b√°sico e incluir essa informa√ß√£o na resposta.  
‚úÖ O JSON retornado ao usu√°rio deve conter **somente os dados do relat√≥rio b√°sico**.  

#### **9 Comunica√ß√£o REST e JSON**
**Como sistema, quero expor endpoints REST e garantir que todas as respostas sejam retornadas no formato JSON, garantindo compatibilidade com outras aplica√ß√µes.**  
üõ† **Crit√©rios de Aceita√ß√£o:**  
‚úÖ Todos os endpoints devem seguir o padr√£o REST (`/api/v1/reports`).  
‚úÖ O formato de resposta deve ser **estruturado em JSON**.  
‚úÖ O sistema deve seguir boas pr√°ticas de API, como uso de **status codes adequados** (`200 OK`, `400 Bad Request`, `500 Internal Server Error`).  

#### **10 Documenta√ß√£o via Swagger (Opcional)**
**Como sistema, posso disponibilizar documenta√ß√£o da API via Swagger, para facilitar a integra√ß√£o e uso dos endpoints.**  
üõ† **Crit√©rios de Aceita√ß√£o:**  
‚úÖ Se implementado, a documenta√ß√£o Swagger deve listar **todos os endpoints** dispon√≠veis.  
‚úÖ O Swagger deve permitir **testar os endpoints diretamente** via interface web.  
‚úÖ A documenta√ß√£o deve conter **exemplos de requisi√ß√£o e resposta** para cada endpoint.  

---
### **Aplica√ß√£o 2: Relat√≥rio B√°sico**

#### **1Ô∏è Consulta de Informa√ß√µes P√∫blicas de um CPF**  
**Como sistema, quero fornecer informa√ß√µes p√∫blicas de um CPF informado, incluindo Nome, Sexo e Nacionalidade, para atender √†s solicita√ß√µes de relat√≥rios b√°sicos.**  
üõ† **Crit√©rios de Aceita√ß√£o:**  
‚úÖ O sistema deve receber um **CPF v√°lido** e retornar as informa√ß√µes b√°sicas.  
‚úÖ O retorno deve conter os seguintes dados:
   - `"nome"`: Nome completo da pessoa  
   - `"sexo"`: Masculino/Feminino  
   - `"nacionalidade"`: Nacionalidade do indiv√≠duo  
‚úÖ Se o CPF for inv√°lido ou n√£o existir na base, o sistema deve retornar um erro **400 - Bad Request**.  

#### **2Ô∏è Exposi√ß√£o de API REST para Consumo Externo**  
**Como sistema, quero expor um endpoint REST que permita o consumo da API pelo servi√ßo de entrada, garantindo que os relat√≥rios b√°sicos possam ser gerados corretamente.**  
üõ† **Crit√©rios de Aceita√ß√£o:**  
‚úÖ O endpoint REST deve seguir o padr√£o:
   - `GET /api/v1/basic-report/{cpf}`  
‚úÖ A resposta deve ser formatada em **JSON**.  
‚úÖ O endpoint deve validar **o formato do CPF** antes de consultar os dados.  
‚úÖ O tempo de resposta da API deve ser otimizado para **baixo tempo de lat√™ncia**.  

#### **3Ô∏è Tratamento de Erros e Restri√ß√µes**  
**Como sistema, quero garantir que CPFs inv√°lidos ou n√£o encontrados sejam tratados corretamente, evitando inconsist√™ncias nos relat√≥rios.**  
üõ† **Crit√©rios de Aceita√ß√£o:**  
‚úÖ Se o CPF for inv√°lido ou mal formatado, a API deve retornar **400 - Bad Request** com uma mensagem descritiva.  
‚úÖ Se o CPF n√£o for encontrado na base, a API deve retornar **404 - Not Found**.  
‚úÖ Em caso de falha inesperada, a API deve retornar **500 - Internal Server Error**, registrando logs detalhados.  

#### **4 Restri√ß√µes de Acesso aos Dados P√∫blicos**  
**Como sistema, quero garantir que apenas CPFs autorizados possam ser consultados, para proteger dados sens√≠veis e evitar abusos.**  
üõ† **Crit√©rios de Aceita√ß√£o:**  
‚úÖ O acesso √† API deve ser restrito via **token JWT** (se necess√°rio).  
‚úÖ A API deve permitir apenas consultas provenientes do servi√ßo de entrada autorizado.  
‚úÖ Consultas excessivas ou fora dos padr√µes devem ser registradas para auditoria.  

---

### **Aplica√ß√£o 3: Relat√≥rio Completo**

#### **1Ô∏è Consulta de Informa√ß√µes Detalhadas de um CPF**  
**Como sistema, quero fornecer informa√ß√µes detalhadas de um CPF informado, incluindo Endere√ßo, Telefone e Documentos (RG e CPF), para complementar o Relat√≥rio B√°sico.**  
üõ† **Crit√©rios de Aceita√ß√£o:**  
‚úÖ O sistema deve receber um **CPF v√°lido** e retornar as seguintes informa√ß√µes adicionais:  
   - `"endereco"`: Rua, n√∫mero, bairro, cidade, estado e CEP  
   - `"telefone"`: N√∫mero de telefone associado ao CPF  
   - `"documentos"`: RG e CPF  
‚úÖ O formato de resposta deve ser **JSON** e seguir um padr√£o estruturado.  
‚úÖ Se o CPF for inv√°lido ou n√£o existir na base, o sistema deve retornar um erro **400 - Bad Request**.  

#### **2Ô∏è Execu√ß√£o Ass√≠ncrona e Paralela**  
**Como sistema, quero garantir que minha execu√ß√£o seja feita de forma ass√≠ncrona, permitindo que o servi√ßo de entrada processe a requisi√ß√£o sem bloqueios.**  
üõ† **Crit√©rios de Aceita√ß√£o:**  
‚úÖ A aplica√ß√£o **n√£o deve bloquear a requisi√ß√£o** enquanto processa os dados.  
‚úÖ A chamada ao servi√ßo deve permitir **execu√ß√£o em segundo plano**, sem impactar a API de entrada.  
‚úÖ O servi√ßo deve garantir **alta disponibilidade**, respondendo de forma eficiente.  

#### **3Ô∏è Reexecu√ß√£o Autom√°tica em Caso de Falha**  
**Como sistema, quero garantir que, em caso de falha, minha execu√ß√£o seja reprocessada automaticamente at√© duas vezes, com um intervalo de 300ms entre as tentativas.**  
üõ† **Crit√©rios de Aceita√ß√£o:**  
‚úÖ Se a consulta falhar, o sistema deve aguardar **300ms** antes de tentar novamente.  
‚úÖ O sistema deve realizar at√© **2 tentativas adicionais** antes de considerar a requisi√ß√£o como falha.  
‚úÖ Se todas as tentativas falharem, o sistema deve **retornar um erro ao servi√ßo de entrada**, que dever√° ajustar a resposta para um **relat√≥rio b√°sico** e cobrar apenas R$5,00.  

#### **4Ô∏è Exposi√ß√£o de API REST para Consumo Externo**  
**Como sistema, quero expor um endpoint REST que permita o consumo da API pelo servi√ßo de entrada, garantindo que os relat√≥rios completos possam ser gerados corretamente.**  
üõ† **Crit√©rios de Aceita√ß√£o:**  
‚úÖ O endpoint REST deve seguir o padr√£o:
   - `GET /api/v1/full-report/{cpf}`  
‚úÖ A resposta deve ser formatada em **JSON**.  
‚úÖ O endpoint deve validar **o formato do CPF** antes de consultar os dados.  
‚úÖ O tempo de resposta da API deve ser otimizado para **baixo tempo de lat√™ncia**.  

#### **5Ô∏è Tratamento de Erros e Restri√ß√µes**  
**Como sistema, quero garantir que CPFs inv√°lidos ou n√£o encontrados sejam tratados corretamente, evitando inconsist√™ncias nos relat√≥rios.**  
üõ† **Crit√©rios de Aceita√ß√£o:**  
‚úÖ Se o CPF for inv√°lido ou mal formatado, a API deve retornar **400 - Bad Request** com uma mensagem descritiva.  
‚úÖ Se o CPF n√£o for encontrado na base, a API deve retornar **404 - Not Found**.  
‚úÖ Em caso de falha inesperada, a API deve retornar **500 - Internal Server Error**, registrando logs detalhados.  

#### **6Ô∏è Restri√ß√µes de Acesso aos Dados Detalhados**  
**Como sistema, quero garantir que apenas CPFs autorizados possam ser consultados, para proteger dados sens√≠veis e evitar abusos.**  
üõ† **Crit√©rios de Aceita√ß√£o:**  
‚úÖ O acesso √† API deve ser restrito via **token JWT** (se necess√°rio).  
‚úÖ A API deve permitir apenas consultas provenientes do servi√ßo de entrada autorizado.  
‚úÖ Consultas excessivas ou fora dos padr√µes devem ser registradas para auditoria.  

---

### **Aplica√ß√£o 4: Financeiro**

#### **1Ô∏è Processamento de Cobran√ßas via Mensageria**  
**Como sistema, quero processar as cobran√ßas dos relat√≥rios utilizando RabbitMQ, garantindo que a comunica√ß√£o entre servi√ßos seja ass√≠ncrona e eficiente.**  
üõ† **Crit√©rios de Aceita√ß√£o:**  
‚úÖ O sistema deve consumir mensagens de cobran√ßa enviadas pelo **servi√ßo de entrada** via **RabbitMQ**.  
‚úÖ As mensagens devem conter os dados necess√°rios para a cobran√ßa:  
   - `"cpf"`: Identificador do usu√°rio  
   - `"valor"`: Valor a ser cobrado (R$5,00 ou R$10,00)  
   - `"tipoRelatorio"`: B√°sico ou Completo  
‚úÖ O sistema deve **confirmar o processamento** da mensagem para evitar duplica√ß√£o.  

#### **2Ô∏è Escuta de Mensagens de Cobran√ßa**  
**Como sistema, quero escutar mensagens de cobran√ßa enviadas pelo servi√ßo de entrada, para garantir que todas as requisi√ß√µes sejam corretamente processadas.**  
üõ† **Crit√©rios de Aceita√ß√£o:**  
‚úÖ O sistema deve consumir mensagens do t√≥pico de cobran√ßa no **RabbitMQ**.  
‚úÖ Caso a mensagem esteja corrompida ou inv√°lida, deve ser rejeitada e registrada em logs para auditoria.  
‚úÖ O sistema deve suportar **reconex√£o autom√°tica** ao RabbitMQ em caso de falha na conex√£o.  

#### **3Ô∏è Registro de Cobran√ßas Bem-Sucedidas e Falhas para Auditoria**  
**Como sistema, quero registrar cobran√ßas bem-sucedidas e falhas em um banco de dados, garantindo rastreabilidade e auditoria.**  
üõ† **Crit√©rios de Aceita√ß√£o:**  
‚úÖ As cobran√ßas bem-sucedidas devem ser persistidas no banco de dados com os seguintes dados:  
   - `"cpf"`: Identificador do usu√°rio  
   - `"valor"`: Valor cobrado  
   - `"tipoRelatorio"`: B√°sico ou Completo  
   - `"status"`: `"SUCESSO"`  
   - `"dataHora"`: Data e hora do processamento  
‚úÖ Em caso de falha na cobran√ßa, o sistema deve registrar no banco de dados:  
   - `"status"`: `"FALHA"`  
   - `"motivo"`: Descri√ß√£o do erro ocorrido  
‚úÖ O sistema deve expor um **endpoint de consulta de auditoria**, permitindo recuperar cobran√ßas processadas e suas falhas.  

#### **4Ô∏è Rollback da Cobran√ßa em Caso de Falha**  
**Como sistema, quero garantir que o rollback da cobran√ßa seja processado corretamente em caso de falha na gera√ß√£o do relat√≥rio completo, para evitar cobran√ßas indevidas.**  
üõ† **Crit√©rios de Aceita√ß√£o:**  
‚úÖ Se o servi√ßo de **Relat√≥rio Completo** falhar ap√≥s todas as tentativas, o sistema deve processar o rollback da cobran√ßa e **ajustar o valor para R$5,00** (relat√≥rio b√°sico).  
‚úÖ O rollback deve ser realizado enviando uma **nova mensagem para o RabbitMQ**, garantindo a revers√£o da cobran√ßa.  
‚úÖ A revers√£o da cobran√ßa deve ser registrada na auditoria, marcando a transa√ß√£o original como `"REVERTIDO"`.  
‚úÖ O sistema deve garantir que **nenhum usu√°rio seja cobrado erroneamente** em caso de falha do Relat√≥rio Completo.  

---

### **Backlog das Tarefas SCRUM**
Aqui est√£o todas as **tarefas** organizadas em **sprints**, priorizando as mais cr√≠ticas primeiro.

### **üìå Sprint 1: Configura√ß√£o Inicial e Estrutura√ß√£o**

üìå **Objetivo da Sprint 1:**  
Esta sprint tem como foco **configurar a base do projeto**, garantindo que todas as aplica√ß√µes estejam **estruturadas corretamente**, com suas depend√™ncias configuradas e **prontas para desenvolvimento**. Al√©m disso, as **principais integra√ß√µes entre os servi√ßos** (REST e RabbitMQ) ser√£o implementadas e testadas.

### **üìå Tarefas Detalhadas**
#### **1Ô∏è Criar estrutura do projeto e reposit√≥rios**  
üìå **Descri√ß√£o:**  
Configurar o reposit√≥rio Git e criar a estrutura inicial do projeto para todas as aplica√ß√µes:  
   - **Entrada (API Gateway e Orquestrador)**  
   - **Relat√≥rio B√°sico**  
   - **Relat√≥rio Completo**  
   - **Financeiro**  

üõ† **Crit√©rios de Aceita√ß√£o:**  
‚úÖ Criar reposit√≥rio Git e definir a estrutura do c√≥digo-fonte.  
‚úÖ Criar um projeto **Spring Boot 3.4.2 com Java 17** para cada aplica√ß√£o.  
‚úÖ Configurar o **.gitignore** para evitar arquivos desnecess√°rios no reposit√≥rio.  
‚úÖ Criar **pacotes organizados** (`controller`, `service`, `repository`, `model`, etc.).  
‚úÖ Configurar um README inicial com a descri√ß√£o do projeto e estrutura do reposit√≥rio.  

#### **2Ô∏è Configurar aplica√ß√µes Spring Boot 3.4.2 com Java 17**  
üìå **Descri√ß√£o:**  
Configurar **Spring Boot 3.4.2** e definir depend√™ncias principais no `pom.xml` para cada aplica√ß√£o.  

üõ† **Crit√©rios de Aceita√ß√£o:**  
‚úÖ Criar e configurar os projetos Spring Boot com o **Spring Initializr**.  
‚úÖ Definir depend√™ncias necess√°rias para cada aplica√ß√£o:  
   - Entrada: **Spring Web, Spring Boot Actuator, Feign Client, OpenAPI (Swagger - opcional)**.  
   - Relat√≥rios: **Spring Web, Spring Boot Actuator, JPA, H2 ou PostgreSQL**.  
   - Financeiro: **Spring Boot Actuator, Spring Cloud Stream (RabbitMQ)**.  
‚úÖ Criar `application.yml` com as configura√ß√µes iniciais de cada aplica√ß√£o.  
‚úÖ Configurar **porta dos servi√ßos** para evitar conflitos.  

#### **3Ô∏è Criar estrutura de banco de dados relacional no servi√ßo de entrada**  
üìå **Descri√ß√£o:**  
O servi√ßo **Entrada** deve ter um **banco de dados relacional** para armazenar as cobran√ßas antes da gera√ß√£o dos relat√≥rios.  

üõ† **Crit√©rios de Aceita√ß√£o:**  
‚úÖ Criar **entidades JPA** para persist√™ncia dos dados no banco.  
‚úÖ Configurar **Spring Data JPA** e definir reposit√≥rios para acesso aos dados.  
‚úÖ Definir **scripts SQL iniciais** para criar tabelas de cobran√ßa (`cobranca`, `auditoria`, etc.).  
‚úÖ Configurar **H2 (para ambiente de desenvolvimento)** e **PostgreSQL (para produ√ß√£o)**.  

#### **4Ô∏è Implementar comunica√ß√£o entre servi√ßos via REST**  
üìå **Descri√ß√£o:**  
Cada servi√ßo deve se comunicar via **REST**, garantindo **integra√ß√£o eficiente** entre os microsservi√ßos.  

üõ† **Crit√©rios de Aceita√ß√£o:**  
‚úÖ Definir **endpoints REST** para comunica√ß√£o entre os servi√ßos.  
‚úÖ Implementar **Feign Client** no servi√ßo de **Entrada** para consumir os servi√ßos de Relat√≥rios e Financeiro.  
‚úÖ Configurar **tratamento de erros e timeouts** para chamadas externas.  
‚úÖ Criar **testes iniciais de integra√ß√£o** para validar a comunica√ß√£o.  

#### **5Ô∏è Configurar mensageria RabbitMQ no servi√ßo financeiro**  
üìå **Descri√ß√£o:**  
O servi√ßo **Financeiro** deve processar mensagens de cobran√ßa **ass√≠ncronas**, garantindo que os pagamentos sejam controlados corretamente.  

üõ† **Crit√©rios de Aceita√ß√£o:**  
‚úÖ Configurar **RabbitMQ** no ambiente local e definir filas de mensagens.  
‚úÖ Implementar **Spring Cloud Stream** para consumir mensagens de cobran√ßa.  
‚úÖ Criar **produtores e consumidores** de mensagens no RabbitMQ.  
‚úÖ Criar **testes unit√°rios** para validar a comunica√ß√£o com RabbitMQ.  

#### **6Ô∏è Criar testes unit√°rios iniciais para as classes de dom√≠nio**  
üìå **Descri√ß√£o:**  
Criar **testes unit√°rios com JUnit 5 e Mockito** para garantir a integridade das classes de dom√≠nio antes de avan√ßar no desenvolvimento.  

üõ† **Crit√©rios de Aceita√ß√£o:**  
‚úÖ Criar testes para **entidades e reposit√≥rios** (Spring Data JPA).  
‚úÖ Criar testes para **servi√ßos** utilizando **Mockito**.  
‚úÖ Garantir que os testes **rodam automaticamente** no pipeline de CI/CD.  

---

### **üìå Sprint 2: Implementa√ß√£o das Funcionalidades Principais**

üìå **Objetivo da Sprint 2:**  
Nesta sprint, as **funcionalidades centrais** do ecossistema ser√£o implementadas. Isso inclui a cria√ß√£o dos **endpoints principais** em cada microsservi√ßo, garantindo que os relat√≥rios possam ser gerados corretamente e que as cobran√ßas sejam processadas via RabbitMQ. Al√©m disso, ser√£o implementados **testes unit√°rios para regras cr√≠ticas**, como **valida√ß√£o de CPF e rollback financeiro**.

### **üìå Tarefas Detalhadas**
#### **7Ô∏è Implementar servi√ßo de Entrada (API Gateway e Orquestrador)**  
üìå **Descri√ß√£o:**  
O servi√ßo **Entrada** ser√° respons√°vel por **receber as requisi√ß√µes dos usu√°rios**, validar os dados e **orquestrar** chamadas para os servi√ßos de relat√≥rio e financeiro.  

üõ† **Crit√©rios de Aceita√ß√£o:**  
‚úÖ Criar **endpoint REST** para solicita√ß√£o de relat√≥rios:  
   - `POST /api/v1/reports` (entrada de CPF e tipo do relat√≥rio).  
‚úÖ Implementar l√≥gica para **valida√ß√£o de CPF** e **restri√ß√£o caso a soma dos d√≠gitos seja 44**.  
‚úÖ Chamar os servi√ßos de **Relat√≥rio B√°sico e Completo de forma ass√≠ncrona** quando necess√°rio.  
‚úÖ Persistir o **valor cobrado** antes da gera√ß√£o do relat√≥rio no banco de dados.  
‚úÖ Enviar **mensagem de cobran√ßa para o RabbitMQ** antes da gera√ß√£o do relat√≥rio.  
‚úÖ Consolidar os dados retornados dos servi√ßos de relat√≥rio e **retornar um JSON √∫nico**.  

#### **8Ô∏è Implementar servi√ßo de Relat√≥rio B√°sico**  
üìå **Descri√ß√£o:**  
O servi√ßo **Relat√≥rio B√°sico** fornecer√° **dados p√∫blicos do CPF** e ser√° acessado pelo servi√ßo de **Entrada**.  

üõ† **Crit√©rios de Aceita√ß√£o:**  
‚úÖ Criar **endpoint REST** para recuperar dados b√°sicos do CPF:  
   - `GET /api/v1/basic-report/{cpf}`  
‚úÖ Implementar l√≥gica para retornar **Nome, Sexo e Nacionalidade**.  
‚úÖ Implementar **tratamento de erro** para CPF inv√°lido ou inexistente.  
‚úÖ Criar **testes unit√°rios** para garantir a correta gera√ß√£o do relat√≥rio b√°sico.  

#### **9Ô∏è Implementar servi√ßo de Relat√≥rio Completo**  
üìå **Descri√ß√£o:**  
O servi√ßo **Relat√≥rio Completo** fornecer√° **dados detalhados** e ser√° acessado pelo servi√ßo de **Entrada**.  

üõ† **Crit√©rios de Aceita√ß√£o:**  
‚úÖ Criar **endpoint REST** para recuperar dados completos do CPF:  
   - `GET /api/v1/full-report/{cpf}`  
‚úÖ Implementar l√≥gica para retornar **Endere√ßo, Telefone e Documentos (RG e CPF)**.  
‚úÖ Implementar **execu√ß√£o ass√≠ncrona** para permitir que o servi√ßo de Entrada processe a requisi√ß√£o sem bloqueios.  
‚úÖ Implementar **mecanismo de retry** em caso de falha, com **2 novas tentativas e 300ms de intervalo**.  
‚úÖ Criar **testes unit√°rios** para validar o servi√ßo de relat√≥rio completo.  

#### **10 Implementar servi√ßo Financeiro com RabbitMQ**  
üìå **Descri√ß√£o:**  
O servi√ßo **Financeiro** ser√° respons√°vel por **processar as cobran√ßas via RabbitMQ** e garantir rollback quando necess√°rio.  

üõ† **Crit√©rios de Aceita√ß√£o:**  
‚úÖ Criar **consumer de mensagens** para processar cobran√ßas recebidas do servi√ßo de Entrada.  
‚úÖ Implementar **persist√™ncia das cobran√ßas** bem-sucedidas e falhas no banco de dados.  
‚úÖ Criar **endpoint de consulta de auditoria** para visualizar cobran√ßas processadas.  
‚úÖ Criar **mecanismo de rollback**, revertendo a cobran√ßa caso o relat√≥rio completo falhe.  
‚úÖ Criar **testes unit√°rios** para validar a l√≥gica de cobran√ßa e rollback.  

#### **1Ô∏è1 Criar testes unit√°rios para valida√ß√£o de CPF e l√≥gica de restri√ß√£o**  
üìå **Descri√ß√£o:**  
Os testes devem validar **regras cr√≠ticas de CPF**, garantindo que **CPFs inv√°lidos ou restritos** sejam corretamente identificados.  

üõ† **Crit√©rios de Aceita√ß√£o:**  
‚úÖ Testar **valida√ß√£o de CPF** garantindo que formatos inv√°lidos sejam rejeitados.  
‚úÖ Testar **regra de soma dos d√≠gitos do CPF = 44**, garantindo que o relat√≥rio seja bloqueado.  
‚úÖ Testar **respostas adequadas da API** (`400 Bad Request` para CPF inv√°lido, `403 Forbidden` para CPF restrito).  
‚úÖ Cobertura de c√≥digo superior a **90%** para essas regras.  

#### **1Ô∏è2 Criar testes unit√°rios para rollback da cobran√ßa**  
üìå **Descri√ß√£o:**  
Os testes devem garantir que, **caso o relat√≥rio completo falhe**, o rollback da cobran√ßa seja realizado corretamente.  

üõ† **Crit√©rios de Aceita√ß√£o:**  
‚úÖ Testar **rollback da cobran√ßa no banco de dados** caso o relat√≥rio completo falhe.  
‚úÖ Testar **envio de mensagem de revers√£o** para o RabbitMQ.  
‚úÖ Garantir que o **valor correto (R$5,00) seja cobrado** ap√≥s o fallback para relat√≥rio b√°sico.  
‚úÖ Cobertura de c√≥digo superior a **90%** para essa funcionalidade.  

---

### **üìå Sprint 3: Resili√™ncia, Integra√ß√£o e Testes Finais**

üìå **Objetivo da Sprint 3:**  
Nesta sprint, o foco ser√° **garantir a resili√™ncia e robustez do sistema**, implementando **mecanismos de retry e rollback**, al√©m de **testes avan√ßados** para validar sua estabilidade e performance. Tamb√©m ser√£o inclu√≠dos **documenta√ß√£o, arquitetura e suporte a Docker** para facilitar a integra√ß√£o e o deploy.


### **üìå Tarefas Detalhadas**

#### **1Ô∏è3 Implementar mecanismo de reexecu√ß√£o em caso de falha nos relat√≥rios (retry)**  
üìå **Descri√ß√£o:**  
Se um dos servi√ßos de relat√≥rio falhar, o sistema deve tentar novamente antes de considerar a requisi√ß√£o como erro.  

üõ† **Crit√©rios de Aceita√ß√£o:**  
‚úÖ Implementar **retry autom√°tico** para chamadas aos servi√ßos de relat√≥rio, com **at√© 2 tentativas** e **intervalo de 300ms**.  
‚úÖ Caso o servi√ßo responda com erro **5XX (falha interna)**, o sistema deve tentar novamente.  
‚úÖ Se todas as tentativas falharem, o sistema deve **acionar o rollback da cobran√ßa** e retornar o relat√≥rio b√°sico.  
‚úÖ Criar **testes unit√°rios e de integra√ß√£o** simulando falhas e validando o retry.  

#### **1Ô∏è4 Implementar rollback autom√°tico em caso de falha total na gera√ß√£o do relat√≥rio completo**  
üìå **Descri√ß√£o:**  
Caso o relat√≥rio completo n√£o possa ser gerado, o sistema deve garantir que **a cobran√ßa seja revertida** e o relat√≥rio b√°sico seja entregue. 

üõ† **Crit√©rios de Aceita√ß√£o:**  
‚úÖ Se todas as tentativas de retry falharem, o sistema deve:  
   - **Reverter a cobran√ßa do relat√≥rio completo no servi√ßo financeiro**.  
   - **Cobrar apenas R$5,00 pelo relat√≥rio b√°sico**.  
   - **Retornar um JSON contendo somente os dados do relat√≥rio b√°sico**.  
‚úÖ O rollback da cobran√ßa deve ser **registrado no banco de dados e auditado**.  
‚úÖ Criar **testes unit√°rios e de integra√ß√£o** para garantir o correto funcionamento do rollback.  

#### **1Ô∏è5 Criar documenta√ß√£o Swagger para APIs**  
üìå **Descri√ß√£o:**  
A documenta√ß√£o da API deve permitir que desenvolvedores externos entendam e consumam os endpoints do sistema.  

üõ† **Crit√©rios de Aceita√ß√£o:**  
‚úÖ Criar documenta√ß√£o Swagger para todas as APIs, incluindo:  
   - **Entrada (API Gateway)**  
   - **Relat√≥rio B√°sico**  
   - **Relat√≥rio Completo**  
   - **Financeiro**  
‚úÖ Cada endpoint deve ter **descri√ß√£o detalhada dos par√¢metros e respostas esperadas**.  
‚úÖ Incluir **exemplos de requisi√ß√£o e resposta** para facilitar o uso da API.  
‚úÖ Permitir **testes diretos via interface Swagger UI**.  

#### **1Ô∏è6 Implementar Docker e Docker Compose (opcional)**  
üìå **Descri√ß√£o:**  
A aplica√ß√£o deve ter suporte para execu√ß√£o via **Docker**, facilitando deploy e testes locais.  

üõ† **Crit√©rios de Aceita√ß√£o:**  
‚úÖ Criar **Dockerfile** para cada aplica√ß√£o, garantindo que todas as depend√™ncias sejam instaladas corretamente.  
‚úÖ Criar **Docker Compose** para facilitar a execu√ß√£o do ecossistema completo com um √∫nico comando.  
‚úÖ Configurar **volumes e networks** no Docker Compose para garantir a comunica√ß√£o entre os servi√ßos.  
‚úÖ Testar a execu√ß√£o dos containers e validar que todas as aplica√ß√µes sobem corretamente.  

#### **1Ô∏è7 Criar desenho da arquitetura do ecossistema**  
üìå **Descri√ß√£o:**  
A arquitetura do sistema deve ser documentada visualmente para facilitar o entendimento da solu√ß√£o.  

üõ† **Crit√©rios de Aceita√ß√£o:**  
‚úÖ Criar diagrama de arquitetura mostrando a comunica√ß√£o entre os servi√ßos.  
‚úÖ Definir os **principais fluxos de dados** entre os microsservi√ßos.  
‚úÖ Incluir detalhes sobre **RabbitMQ, REST APIs e banco de dados**.  
‚úÖ Criar documenta√ß√£o explicando os principais componentes do sistema.  

#### **1Ô∏è8 Realizar testes integrados de ponta a ponta**  
üìå **Descri√ß√£o:**  
Os testes de integra√ß√£o devem validar que todos os microsservi√ßos **se comunicam corretamente** e que o fluxo completo de gera√ß√£o de relat√≥rio funciona sem erros.  

üõ† **Crit√©rios de Aceita√ß√£o:**  
‚úÖ Criar **testes automatizados** que simulam uma requisi√ß√£o completa do usu√°rio:  
   - Entrada de CPF e solicita√ß√£o de relat√≥rio.  
   - Valida√ß√£o da cobran√ßa e gera√ß√£o do relat√≥rio.  
   - Comunica√ß√£o entre os servi√ßos e retorno correto da resposta.  
‚úÖ Simular **cen√°rios de erro**, como:  
   - Servi√ßo de relat√≥rio indispon√≠vel.  
   - Falha na comunica√ß√£o RabbitMQ.  
   - Timeout na gera√ß√£o do relat√≥rio.  
‚úÖ Garantir que os testes **passam em 100% das execu√ß√µes** antes do deploy.  

#### **1Ô∏è9 Validar performance e comportamento em cen√°rios de erro**  
üìå **Descri√ß√£o:**  
Antes do go-live, a aplica√ß√£o deve ser testada sob **carga** para garantir que suporta m√∫ltiplas requisi√ß√µes simult√¢neas sem degrada√ß√£o de performance.  

üõ† **Crit√©rios de Aceita√ß√£o:**  
‚úÖ Testar **tempo de resposta m√©dio** para gera√ß√£o dos relat√≥rios.  
‚úÖ Testar **comportamento sob carga alta** (100+ requisi√ß√µes simult√¢neas).  
‚úÖ Validar **uso de mem√≥ria e CPU**, garantindo que os servi√ßos se mant√™m est√°veis.  
‚úÖ Simular falhas em servi√ßos cr√≠ticos e validar a resposta do sistema.  

---
